---
title: "Observability"
tags: ["service-development", "logging"]
---

export {default as default} from './../../../../components/post-layout';

# Observability

Software nowadays are no logger a single application or code in a single repository that can be build and tested and run independently. Breaking up monolith applications to microservices and deploying them to the cloud or in multiple containers have pushed the systems to be scattered, more remote and less likely to be under the direct control of the developers. With infrastructure and networking being more stable, failures to systems are more often due to application errors or due to the complex interaction between the microservices.

Takeaway
>    Failure is relocating to the application code.

Cloud native systems are made of many blocks that can cease to work as intended. These blocks are also meant to be under constant use, change and improvement depending on the business pressures. And thus to be able to work better with these systems, observability of the systems will need to be increased.

From wiki:
> Observability is a measure of how well internal states of a system can be inferred from knowledge of its external outputs.

In software engineering terms, this means that we should be able understand what is taking place in the system by just checking the outputs generated by the application. External outputs can take multiple forms, but here we will be focusing on logs.

!!! Takeaway

    Observability of a system is the ability to observe the state of the system, and this is controlled by what the system exposes about itself.

## Monitoring

Now before talking about observability, let's talk briefly about monitoring and how it relates to observability.

Monitoring is the action of checking on whether a system is working or not. The focus is on the health of the system. eg: checking disk space, inodes, memory usage etc and generating alerts if a certain threshold is breached is part of monitoring the system. The focus of monitoring is to capture the metrics.

Observability is understanding the reason why the system is not working. The focus of observability is more on the analysis of the captured metrics and providing insight into the application.

More details on monitoring and observability can be found [here](../operability.md).

## Logging and Observability

The way logging fits into observability is in that logs provide revelation on the state of the application. If the logs contain enough information relevant to the system's state, it can be used for observability. Looking at one log event of an activity, it will just provide us the state of the system at that time and nothing more. Whereas analysing multiple log events for the same activity will provide a lot of understanding and we can gather good feedback for the activity.

Let's look at an example to get a better understanding of the role of logs in observability.

```sh
Sep 27 16:13:16 armakuni.tk-learning.ak-raindrops bb62be68-7829-44f6-ac88-ccc1eed010e7/[RTR/6]: ak-raindrops-fearless-kookaburra.cfapps.io - [2018-09-27T23:13:15.242+0000] "GET /period/10 HTTP/1.1" 200 0 52 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36" "10.10.66.49:58376" "10.10.149.233:61086" x_forwarded_for:"86.159.227.161, 10.10.66.49" x_forwarded_proto:"http" vcap_request_id:"b5174259-5823-4dbf-7608-4745c418a5d2" response_time:0.070358043 app_id:"bb62be68-7829-44f6-ac88-ccc1eed010e7" app_index:"0" x_b3_traceid:"9728e528008bee29" x_b3_spanid:"9728e528008bee29" x_b3_parentspanid:"-"
```

The log event above has captured lot of information of the api call. We can see the api being called, the ip, OS, browser and response time of the api call. If we only look at this one log event we can figure out that the response time to be 0.07. That is just a fact and does not give us anymore insight to the api. Was this response time fast or slow? To gain a better understanding of the system, we need more logs events for the same api call.

```sh
Sep 27 16:19:16 armakuni.tk-learning.ak-raindrops bb62be68-7829-44f6-ac88-ccc1eed010e7/[RTR/8]: ak-raindrops-fearless-kookaburra.cfapps.io - [2018-09-27T23:19:16.390+0000] "GET /period/10 HTTP/1.1" 200 0 46 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36" "10.10.66.49:55352" "10.10.149.233:61086" x_forwarded_for:"86.159.227.161, 10.10.66.49" x_forwarded_proto:"http" vcap_request_id:"b83c0971-0211-483e-751a-e5d48c2128d5" response_time:1.374454072 app_id:"bb62be68-7829-44f6-ac88-ccc1eed010e7" app_index:"0" x_b3_traceid:"b9739ec8ffed5830" x_b3_spanid:"b9739ec8ffed5830" x_b3_parentspanid:"-"

Sep 27 16:20:03 armakuni.tk-learning.ak-raindrops bb62be68-7829-44f6-ac88-ccc1eed010e7/[RTR/3]: ak-raindrops-fearless-kookaburra.cfapps.io - [2018-09-27T23:20:03.146+0000] "GET /period/10 HTTP/1.1" 200 0 53 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36" "10.10.66.49:59222" "10.10.149.233:61086" x_forwarded_for:"86.159.227.161, 10.10.66.49" x_forwarded_proto:"http" vcap_request_id:"7d6d525b-55bf-4439-5881-ef19d320472f" response_time:2.07966165 app_id:"bb62be68-7829-44f6-ac88-ccc1eed010e7" app_index:"0" x_b3_traceid:"a41dbe0428af81d6" x_b3_spanid:"a41dbe0428af81d6" x_b3_parentspanid:"-"
```

From these two log events, we can say the first api call was fast. We can also observe that the response time is increasing with each call from 0.07 to 1.3 to 2.0 seconds. From observing this pattern, we can understand that each call to the api is slowing the application down and there could be some performance issue. There is no actual issue with the application and is still running. Albeit a slightly slower user experience as time goes on. But now the developers have information to focus on tackling the performance issues of the api call.

# Structured Logging

The above example logs are created using string logs. Those kind of logs have an issue around parsing and usability of the data. So an improvement you can do on them is convert them into structured logs. Structured logs are basically size-unbound key-value pairs.

If we were to convert the first example to structured logs, you could end with something like:
```json
{
   "date":"Sep 27 16:13:16"
   "endpoint": "armakuni.tk-learning.ak-raindrops"
   "some-other-data": "bb62be68-7829-44f6-ac88-ccc1eed010e7/[RTR/6]: ak-raindrops-fearless-kookaburra.cfapps.io - [2018-09-27T23:13:15.242+0000]"
   "operation": "GET /period/10 HTTP/1.1"
   "response-code": 200
   "some-value": 0
   "transferred": 52
   "response-body": "-"
   "agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36"
   "some-ip""10.10.66.49:58376"
   "some-other-ip": "10.10.149.233:61086"
   "x_forwarded_for": ["86.159.227.161", "10.10.66.49"]
   "x_forwarded_proto":"http"
   "vcap_request_id":"b5174259-5823-4dbf-7608-4745c418a5d2"
   "response_time": 0.070358043
   "app_id": "bb62be68-7829-44f6-ac88-ccc1eed010e7"
   "app_index": "0"
   "x_b3_traceid":"9728e528008bee29"
   "x_b3_spanid":"9728e528008bee29"
   "x_b3_parentspanid":"-"
}
```

The advantage of the above is that it becomes trivial to use a json parsing library to manipulate the data (search, sort, filter, ...)

Tooling like [AWS Cloudwatch](https://aws.amazon.com/cloudwatch/), [Honeycomb](https://www.honeycomb.io/), [Elasticsearch](https://www.elastic.co/elasticsearch/) put to good use structured logs.

The structured logs doesn't need to be in json format, though seems to be the one used by most tools.

# Further Reading

- [Observability: A Manifesto](https://www.honeycomb.io/blog/observability-a-manifesto/)
- [Charity's Logs vs Structured Events](https://charity.wtf/2019/02/05/logs-vs-structured-events/)
- [Google Cloud Structured logging](https://cloud.google.com/logging/docs/structured-logging)
- [Honeycomb's How are structured logs different from events](https://www.honeycomb.io/blog/how-are-structured-logs-different-from-events/)
- [Stackify's What is structured logging and why developers need it](https://stackify.com/what-is-structured-logging-and-why-developers-need-it/)
